import React, { useEffect, useMemo, useRef, useState } from 'react';
import { Inventory, Slot } from '../../typings';
import WeightBar from '../utils/WeightBar';
import InventorySlot from './InventorySlot';
import { getTotalWeight } from '../../helpers';
import { useAppSelector } from '../../store';
import { useIntersection } from '../../hooks/useIntersection';
import { CircularProgressbar, buildStyles } from 'react-circular-progressbar';
import 'react-circular-progressbar/dist/styles.css';
import { useConfig } from '../..//hooks/useConfig'


const PAGE_SIZE = 30;

const InventoryGrid: React.FC<{ inventory: Inventory, slots?: Slot[], combinedWeight?: number }> = ({ inventory, slots, combinedWeight }) => {
  const { config, loading } = useConfig()
  const theme = config.themes?.[config.theme || 'yellow'];
  const weight = useMemo(
    () => {
      if (combinedWeight !== undefined) {
        return combinedWeight;
      }
      return (inventory.maxWeight !== undefined ? Math.floor(getTotalWeight(slots || inventory.items) * 1000) / 1000 : 0);
    },
    [inventory.maxWeight, slots, inventory.items, combinedWeight]
  );
  const [page, setPage] = useState(0);
  const containerRef = useRef(null);
  const { ref, entry } = useIntersection({ threshold: 0.5 });
  const isBusy = useAppSelector((state) => state.inventory.isBusy);

  useEffect(() => {
    if (entry && entry.isIntersecting) {
      setPage((prev) => ++prev);
    }
  }, [entry]);
  return (
    <>
      <div className="inventory-grid-wrapper" style={{ pointerEvents: isBusy ? 'none' : 'auto' }}>
        <div>
          <div className="inventory-grid-header-wrapper">
            <div className="leftFrame" style={{
              background: `radial-gradient(87.5% 87.5% at 50% 50%, ${theme?.rgbColor1} 0%, ${theme?.rgbColor2} 100%)`
            }}>
              <svg className='frame' xmlns="http://www.w3.org/2000/svg" width="14" height="18" viewBox="0 0 14 18" fill="none">
                <path d="M2.63577 12.758H11.3643V15.2577H2.63577V12.758ZM13.9865 1.94831L12.9933 6.05016C13.39 6.91151 13.596 7.84871 13.5972 8.79741L13.6103 16.3681C13.6112 16.5799 13.5702 16.7897 13.4897 16.9854C13.4092 17.1812 13.2908 17.359 13.1414 17.5086C12.9926 17.659 12.8157 17.7783 12.6206 17.8597C12.4256 17.9411 12.2164 17.9829 12.0052 17.9826L2.01368 18H2.0109C1.12593 18 0.404552 17.2782 0.402937 16.3912L0.389932 8.82042C0.388228 7.838 0.599359 6.8883 1.00027 6.02301L0.0135028 1.94831C-0.0114351 1.84519 -0.00164648 1.7367 0.0413434 1.63974C0.0843333 1.54277 0.15811 1.46279 0.251182 1.41224L1.90157 0.516025C1.96613 0.480954 2.03787 0.461214 2.11125 0.458327C2.18463 0.455439 2.25769 0.469481 2.3248 0.49937C2.39191 0.52926 2.45127 0.574197 2.49832 0.630719C2.54536 0.68724 2.57882 0.753835 2.59613 0.82537L3.2149 3.38068C3.50833 3.17489 3.81805 2.99347 4.14095 2.83823V2.49966C4.14086 1.12132 5.25957 0 6.6347 0H7.36531C8.74044 0 9.85915 1.12132 9.85915 2.49966V2.84946C10.1809 3.00556 10.4895 3.18745 10.782 3.39336L11.4038 0.82537C11.4211 0.753845 11.4546 0.687262 11.5016 0.630751C11.5487 0.57424 11.608 0.52931 11.6751 0.499423C11.7422 0.469536 11.8153 0.455491 11.8887 0.458369C11.962 0.461247 12.0338 0.480973 12.0984 0.516025L13.7487 1.41224C13.8418 1.46277 13.9156 1.54276 13.9586 1.63972C14.0016 1.73668 14.0114 1.84518 13.9865 1.94831ZM5.10171 2.46613C5.71194 2.2837 6.34528 2.19065 6.98207 2.18987H6.99382C7.656 2.18987 8.29522 2.28966 8.89874 2.47296C8.8843 1.63716 8.20257 0.961478 7.3654 0.961478H6.63479C5.79977 0.961388 5.11974 1.63348 5.10171 2.46613ZM12.3235 12.2773C12.3235 12.1499 12.2729 12.0276 12.183 11.9374C12.0931 11.8473 11.9711 11.7966 11.8439 11.7966H2.1562C2.02901 11.7966 1.90703 11.8473 1.81709 11.9374C1.72715 12.0276 1.67663 12.1499 1.67663 12.2773V15.7385C1.67663 15.8016 1.68903 15.8641 1.71313 15.9224C1.73723 15.9808 1.77256 16.0337 1.81709 16.0784C1.86162 16.123 1.91449 16.1584 1.97268 16.1826C2.03086 16.2067 2.09322 16.2192 2.1562 16.2192H11.8439C11.9069 16.2192 11.9692 16.2067 12.0274 16.1826C12.0856 16.1584 12.1385 16.123 12.183 16.0784C12.2275 16.0337 12.2629 15.9808 12.287 15.9224C12.3111 15.8641 12.3235 15.8016 12.3235 15.7385V12.2773ZM12.3235 9.04086C12.3235 6.09862 9.93538 3.70495 7 3.70495C4.06463 3.70495 1.67654 6.09862 1.67654 9.04086C1.67654 9.16835 1.72706 9.29061 1.817 9.38076C1.90694 9.47091 2.02892 9.52155 2.15611 9.52155C2.2833 9.52155 2.40528 9.47091 2.49522 9.38076C2.58516 9.29061 2.63568 9.16835 2.63568 9.04086C2.63568 6.62876 4.59344 4.66643 6.99992 4.66643C9.40639 4.66643 11.3641 6.62876 11.3641 9.04086C11.3666 9.16676 11.4182 9.28668 11.5079 9.37486C11.5976 9.46304 11.7182 9.51243 11.8438 9.51243C11.9694 9.51243 12.0901 9.46304 12.1798 9.37486C12.2694 9.28668 12.321 9.16676 12.3235 9.04086Z" fill={theme?.mainColor}/>
              </svg>
            </div>

            <p>{inventory.label || 'Other Inventory'}</p>
            <div className="description2">{config.ui_rightInventoryDescription || 'Lorem ipsum dolor sit amet consectetur'}</div>
            <div className="texts">
              <div className="weightText2">{config.ui_weight || "Weight"}</div>
              {inventory.maxWeight && (
                <div className="weightText">{weight / 1000}<span className='texttype2'> / {inventory.maxWeight / 1000}kg</span></div>
              )}
            </div>
          </div>
          <div className='prog' style={{ width: "3.3533vh", height: "3.3533vh", display: "flex" }}>
            <svg className='svg' xmlns="http://www.w3.org/2000/svg" width="12" height="14" viewBox="0 0 12 14" fill="none">
              <path d="M11.9897 13.176L10.6012 4.88336C10.5453 4.54952 10.274 4.3065 9.95708 4.3065H7.64779C8.08076 3.84998 8.34984 3.21577 8.34984 2.51535C8.34984 1.12837 7.29573 0 6.00002 0C4.70432 0 3.65016 1.12837 3.65016 2.51535C3.65016 3.21577 3.91924 3.84998 4.35222 4.3065H2.04293C1.72603 4.3065 1.45473 4.54952 1.3988 4.88336L0.0102621 13.176C-0.0238963 13.3801 0.0281484 13.59 0.152523 13.749C0.276855 13.9081 0.460647 14 0.654386 14H11.3456C11.5394 14 11.7231 13.9081 11.8475 13.749C11.9718 13.59 12.0239 13.3801 11.9897 13.176ZM6.00002 1.40094C6.57409 1.40094 7.04109 1.90085 7.04109 2.51535C7.04109 3.12985 6.57409 3.6298 6.00002 3.6298C5.42596 3.6298 4.95891 3.12985 4.95891 2.51535C4.95891 1.90085 5.42596 1.40094 6.00002 1.40094ZM5.82901 10.8398C5.79494 10.9071 5.72916 10.949 5.6577 10.949H5.34901C5.27982 10.949 5.21578 10.9097 5.18079 10.8458L4.41683 9.44974L3.92827 9.98359V10.6265C3.92827 10.8046 3.79338 10.949 3.627 10.949C3.46061 10.949 3.32572 10.8046 3.32572 10.6265V8.07691C3.32572 7.8988 3.46061 7.75441 3.627 7.75441C3.79338 7.75441 3.92827 7.8988 3.92827 8.07691V9.17296L5.08778 7.82189C5.12469 7.77888 5.17678 7.75441 5.23131 7.75441H5.49624C5.57451 7.75441 5.64513 7.80447 5.67572 7.88157C5.70625 7.95866 5.69077 8.04786 5.63641 8.10805L4.83214 8.99859L5.82112 10.6265C5.86007 10.6907 5.86313 10.7726 5.82901 10.8398ZM8.79739 10.4144C8.79739 10.4778 8.77034 10.5381 8.72406 10.5776C8.60383 10.6803 8.44543 10.7725 8.24885 10.8541C8.00926 10.9536 7.76666 11.0034 7.52105 11.0034C7.20887 11.0034 6.93687 10.9333 6.7047 10.7931C6.4727 10.653 6.29824 10.4525 6.18155 10.1917C6.06481 9.93091 6.00648 9.64732 6.00648 9.34074C6.00648 9.00811 6.07161 8.71242 6.20192 8.4539C6.33218 8.19528 6.52287 7.99705 6.77398 7.85896C6.96523 7.75296 7.20346 7.69986 7.48847 7.69986C7.85897 7.69986 8.14834 7.78308 8.35669 7.94942C8.44695 8.02147 8.52325 8.10548 8.58559 8.2014C8.64518 8.29307 8.65727 8.4108 8.61774 8.51409C8.57822 8.61744 8.4925 8.69239 8.38993 8.71293L8.38924 8.71307C8.26909 8.73712 8.14729 8.68015 8.08225 8.56938C8.04063 8.4985 7.98754 8.43783 7.9231 8.38735C7.80702 8.29657 7.66214 8.25118 7.48847 8.25118C7.22515 8.25118 7.01579 8.34056 6.86048 8.51918C6.70509 8.69794 6.6274 8.96305 6.6274 9.31459C6.6274 9.69378 6.70605 9.97812 6.86354 10.1677C7.02094 10.3573 7.2272 10.4521 7.4824 10.4521C7.60857 10.4521 7.73512 10.4256 7.86203 10.3725C7.98885 10.3195 8.09778 10.2552 8.18874 10.1797V9.77433H7.75009C7.61123 9.77433 7.49872 9.65385 7.49872 9.50526C7.49872 9.35662 7.61127 9.23619 7.75009 9.23619H8.60248C8.71014 9.23619 8.79739 9.32963 8.79739 9.44483V10.4144Z" fill="white" fill-opacity="0.5"/>
            </svg>
            <CircularProgressbar value={inventory.maxWeight ? (weight / inventory.maxWeight) * 100 : 0}   styles={{
              root: {},
              path: {
                stroke: `${theme?.mainColor}`,
                transition: 'stroke-dashoffset 0.5s ease 0s',
              },
              trail: {
                stroke: 'rgba(255, 255, 255, 0.10)',
              }
            }}/>
          </div>
        </div>

        <div className="inventory-grid-container" ref={containerRef}>
          <>
            {(slots || inventory.items).slice(0, (page + 1) * PAGE_SIZE).map((item, index) => (
              <InventorySlot
                key={`${inventory.type}-${inventory.id}-${item.slot}`}
                item={item}
                ref={index === (page + 1) * PAGE_SIZE - 1 ? ref : null}
                inventoryType={inventory.type}
                inventoryGroups={inventory.groups}
                inventoryId={inventory.id}
              />
            ))}
          </>
        </div>
      </div>
    </>
  );
};

export default InventoryGrid;
